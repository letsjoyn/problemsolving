# GitHub Action to auto-sync Codeforces solutions

name: Codeforces Auto-Sync

on:
  schedule:
    # Runs every 15 minutes. You can change this cron job.
    - cron: "*/15 * * * *"  
  workflow_dispatch:        # Allows you to run it manually

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests lxml

      - name: Run CF-Sync Script
        env:
          # !!! IMPORTANT: CHANGE THIS TO YOUR HANDLE !!!
          CF_HANDLE: "joynnayvedya"

          # This uses the secret you just made
          GH_TOKEN: ${{ secrets.GH_TOKEN }} 

          # Change this to 'main' if that is your default branch
          TARGET_BRANCH: "main" 

        # This is the Python script that does the work
        run: |
          import requests
          import os
          import json
          import time
          from lxml import html

          handle = os.environ['CF_HANDLE']
          api_url = f"https://codeforces.com/api/user.status?handle={handle}&from=1&count=50"
          history_file = "codeforces_submission_history.json"

          # This is the folder you created in Step 2
          target_dir = "Codeforces" 

          # --- 1. Load history ---
          try:
            with open(history_file, 'r') as f:
              processed_ids = set(json.load(f))
          except FileNotFoundError:
            processed_ids = set()

          # --- 2. Fetch new submissions ---
          try:
            response = requests.get(api_url)
            response.raise_for_status()
            submissions = response.json()['result']
          except Exception as e:
            print(f"Error fetching from Codeforces API: {e}")
            exit(1)

          new_submissions = 0
          for sub in reversed(submissions): # Process oldest first
            if sub['id'] not in processed_ids and sub.get('verdict') == 'OK':
              problem = sub['problem']
              contest_id = problem.get('contestId', '0') # Handle gym problems
              problem_index = problem['index']
              problem_name = problem['name'].replace(' ', '_').replace('/', '_').replace('\\', '_')
              lang_ext = sub['programmingLanguage'].lower()

              # --- 3. Determine file extension ---
              if 'c++' in lang_ext: ext = 'cpp'
              elif 'python' in lang_ext: ext = 'py'
              elif 'java' in lang_ext: ext = 'java'
              elif 'c#' in lang_ext: ext = 'cs'
              else: ext = 'txt'

              filename = f"{contest_id}{problem_index}_{problem_name}.{ext}"
              filepath = os.path.join(target_dir, str(contest_id), filename)

              # --- 4. Get submission source code ---
              try:
                sub_url = f"https://codeforces.com/contest/{contest_id}/submission/{sub['id']}"
                page_response = requests.get(sub_url, headers={'User-Agent': 'Mozilla/5.0'})
                page_response.raise_for_status()
                tree = html.fromstring(page_response.content)
                code_element = tree.xpath('//pre[contains(@id, "program-source-text")]')
                if code_element:
                    code = code_element[0].text_content()
                else:
                    print(f"Could not find code for {filename}")
                    continue
              except Exception as e:
                print(f"Error scraping {sub_url}: {e}")
                continue

              # --- 5. Write file and update history ---
              os.makedirs(os.path.dirname(filepath), exist_ok=True)
              with open(filepath, 'w', encoding='utf-8') as f:
                f.write(code)

              print(f"New solution added: {filepath}")
              processed_ids.add(sub['id'])
              new_submissions += 1
              time.sleep(1) # Be nice to CF API

          if new_submissions > 0:
            print(f"Added {new_submissions} new solutions.")
            # --- 6. Update history file ---
            with open(history_file, 'w') as f:
              json.dump(list(processed_ids), f)
          else:
            print("No new accepted solutions found.")

      # This step automatically commits the new files
      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Auto-sync Codeforces solutions"
          repository: .
          token: ${{ secrets.GH_TOKEN }}
          branch: ${{ env.TARGET_BRANCH }}
          files: 
            - "Codeforces/"
            - "codeforces_submission_history.json"
